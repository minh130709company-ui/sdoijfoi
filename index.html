<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title> <!-- ƒê·ªÉ tr·ªëng ti√™u ƒë·ªÅ -->
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            font-family: 'Dancing Script', cursive;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff99cc;
            text-shadow: 0 0 20px #ff3399, 2px 2px 0 #ffffff;
            font-size: 2.5rem;
            text-align: center;
            z-index: 10;
            opacity: 0;
            transition: opacity 2s;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 20px 40px;
            border-radius: 60px 20px 60px 20px;
            backdrop-filter: blur(5px);
            border: 2px solid #ff99cc;
            line-height: 1.4;
            white-space: normal;
            max-width: 90%;
        }
        #message.show {
            opacity: 1;
        }
        #final-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffb6c1;
            font-size: 3.5rem;
            text-align: center;
            z-index: 30;
            opacity: 0;
            transition: opacity 3s;
            pointer-events: none;
            text-shadow: 0 0 30px #ff69b4, 0 0 60px #ff1493;
            background: transparent;
            border: none;
            white-space: nowrap;
        }
        #final-message.show {
            opacity: 1;
        }
        #music-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border: 2px solid #ff99cc;
            color: #ff99cc;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 0 20px #ff3388;
            transition: 0.3s;
        }
        #music-toggle:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }
        @media (max-width: 600px) {
            #message {
                font-size: 1.8rem;
                padding: 15px 20px;
            }
            #final-message {
                font-size: 2.5rem;
                white-space: normal;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="heartCanvas"></canvas>
    <div id="message">ch√∫c b√© B·ªëng, d∆∞a h·∫•u, m·∫∑t tr·ªùi v√† c√¥ng ch√∫a b√© b·ªèng c·ªßa Minhhh valentine vui v·∫ª,<br>ch√∫c con nh·ª£n xinhhh g√°i m√£i m√£i b√™n m√¨nh.</div>
    <div id="final-message">valentine vui v·∫ª em b√© nkaaa</div>
    <div id="music-toggle">üîá</div>
    <audio id="bg-music" preload="auto">
        <source src="hien.m4a" type="audio/mp4">
    </audio>

    <script>
        const canvas = document.getElementById('heartCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        let hearts = [];
        const MAX_HEARTS = 200; // Gi·∫£m ƒë·ªÉ ƒë·ª° lag tr√™n iPhone

        const messageEl = document.getElementById('message');
        const finalMessageEl = document.getElementById('final-message');
        let phase = 0; // 0: prelude, 1: explosion, 2: final black
        let explosionTriggered = false;
        let finalTriggered = false;

        const music = document.getElementById('bg-music');
        const musicToggle = document.getElementById('music-toggle');
        let musicPlaying = false;

        function resizeCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Heart {
            constructor(x, y, vx, vy, size, color) {
                this.x = x ?? Math.random() * width;
                this.y = y ?? Math.random() * height;
                this.vx = vx ?? (Math.random() - 0.5) * 2;
                this.vy = vy ?? (Math.random() - 0.5) * 2 + 1;
                this.size = size ?? Math.random() * 20 + 10;
                this.color = color ?? `hsl(${Math.random() * 20 + 330}, 80%, 70%)`;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                // Wrap around edges
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;

                this.vy += 0.05; // tr·ªçng l·ª±c nh·∫π
            }

            draw() {
                ctx.font = `${this.size}px 'Segoe UI', 'Arial', sans-serif`;
                ctx.fillStyle = this.color;
                ctx.fillText('‚ù§Ô∏è', this.x, this.y);
            }
        }

        function initPrelude() {
            for (let i = 0; i < 60; i++) { // Gi·∫£m s·ªë l∆∞·ª£ng ban ƒë·∫ßu
                hearts.push(new Heart());
            }
        }
        initPrelude();

        function triggerExplosion() {
            if (explosionTriggered) return;
            explosionTriggered = true;

            messageEl.classList.add('show'); // Hi·ªán d√≤ng ch·ªØ c≈© (s·∫Ω b·ªã ·∫©n sau)
            phase = 1;

            const centerX = width / 2;
            const centerY = height / 2;

            // ƒê·∫©y c√°c tim hi·ªán c√≥ ra xa
            hearts.forEach(heart => {
                const dx = heart.x - centerX;
                const dy = heart.y - centerY;
                const dist = Math.hypot(dx, dy) || 1;
                heart.vx = (dx / dist) * (Math.random() * 8 + 4);
                heart.vy = (dy / dist) * (Math.random() * 8 + 4);
                heart.vx += (Math.random() - 0.5) * 2;
                heart.vy += (Math.random() - 0.5) * 2;
            });

            // Th√™m nhi·ªÅu tim n·ªï t·ª´ t√¢m
            for (let i = 0; i < 100; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 10 + 5;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                const size = Math.random() * 30 + 15;
                const color = `hsl(${Math.random() * 20 + 330}, 90%, 70%)`;
                hearts.push(new Heart(centerX, centerY, vx, vy, size, color));
            }

            if (hearts.length > MAX_HEARTS) {
                hearts = hearts.slice(-MAX_HEARTS);
            }
        }

        function goToFinal() {
            if (finalTriggered) return;
            finalTriggered = true;

            // Chuy·ªÉn sang phase 2: x√≥a to√†n b·ªô tim, n·ªÅn ƒëen, hi·ªán d√≤ng ch·ªØ cu·ªëi
            phase = 2;
            hearts = []; // X√≥a h·∫øt tim

            // ·∫®n message c≈©
            messageEl.classList.remove('show');
            // Hi·ªán message cu·ªëi
            finalMessageEl.classList.add('show');

            // D·ª´ng nh·∫°c n·∫øu ƒëang ph√°t
            if (musicPlaying) {
                music.pause();
                musicPlaying = false;
                musicToggle.innerHTML = 'üîá';
            }
        }

        // Sau 20 gi√¢y k·ªÉ t·ª´ khi load trang, k√≠ch ho·∫°t n·ªï, r·ªìi 1 gi√¢y sau chuy·ªÉn final
        setTimeout(() => {
            triggerExplosion();
            setTimeout(() => {
                goToFinal();
            }, 1000); // 1 gi√¢y sau n·ªï th√¨ chuy·ªÉn ƒëen
        }, 20000); // 20 gi√¢y

        // N·∫øu ng∆∞·ªùi d√πng click v√†o canvas c≈©ng c√≥ th·ªÉ k√≠ch ho·∫°t n·ªï s·ªõm (gi·ªØ l·∫°i ƒë·ªÉ test)
        canvas.addEventListener('click', () => {
            if (!explosionTriggered) triggerExplosion();
        });
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!explosionTriggered) triggerExplosion();
        });

        function animate() {
            // V·∫Ω n·ªÅn t·ªëi (gradient nh·∫π)
            if (phase === 2) {
                // N·ªÅn ƒëen ho√†n to√†n
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, width, height);
            } else {
                // N·ªÅn gradient t·ªëi nh∆∞ c≈©
                const gradient = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, Math.max(width, height));
                gradient.addColorStop(0, '#220011');
                gradient.addColorStop(0.5, '#330022');
                gradient.addColorStop(1, '#110011');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
            }

            // V·∫Ω tim (n·∫øu phase ch∆∞a ph·∫£i 2)
            if (phase !== 2) {
                for (let i = 0; i < hearts.length; i++) {
                    hearts[i].update();
                    hearts[i].draw();
                }

                // Th√™m tim m·ªõi trong prelude
                if (phase === 0 && hearts.length < 100) {
                    if (Math.random() < 0.05) {
                        hearts.push(new Heart());
                    }
                }

                // Trong explosion, th√™m tim t·ª´ t√¢m li√™n t·ª•c
                if (phase === 1 && hearts.length < MAX_HEARTS) {
                    if (Math.random() < 0.1) {
                        const fromCenter = Math.random() > 0.5;
                        if (fromCenter) {
                            const angle = Math.random() * Math.PI * 2;
                            const speed = Math.random() * 6 + 3;
                            const vx = Math.cos(angle) * speed;
                            const vy = Math.sin(angle) * speed;
                            hearts.push(new Heart(width/2, height/2, vx, vy, Math.random()*25+10));
                        }
                    }
                }
            }

            requestAnimationFrame(animate);
        }
        animate();

        // X·ª≠ l√Ω nh·∫°c n·ªÅn (ch·ªâ ph√°t 1 l·∫ßn)
        musicToggle.addEventListener('click', () => {
            if (musicPlaying) {
                music.pause();
                musicToggle.innerHTML = 'üîá';
                musicPlaying = false;
            } else {
                music.play().then(() => {
                    musicPlaying = true;
                    musicToggle.innerHTML = 'üéµ';
                }).catch(() => {});
            }
        });

        // T·ª± ƒë·ªông th·ª≠ ph√°t nh·∫°c khi ng∆∞·ªùi d√πng click l·∫ßn ƒë·∫ßu (t√πy ch·ªçn)
        document.body.addEventListener('click', function initMusic() {
            if (!musicPlaying && music.paused) {
                music.play().then(() => {
                    musicPlaying = true;
                    musicToggle.innerHTML = 'üéµ';
                }).catch(() => {});
            }
        }, { once: true });

        window.addEventListener('load', resizeCanvas);
    </script>
</body>
</html>
